# 12. Collections

Collections in PL/SQL are data structures that allow you to store multiple values of the same type in a single variable. They are useful for handling sets of data in a flexible and efficient way. PL/SQL collections come in three types:

- **Associative Arrays (formerly known as Index-By Tables)**
- **Nested Tables**
- **VARRAYs (Variable-Size Arrays)**

This document provides a comprehensive overview of each collection type, including their use cases and examples.

## Table of Contents

- [Overview of Collections](#overview-of-collections)
- [Associative Arrays](#associative-arrays)
  - [Definition](#definition)
  - [Use Cases](#use-cases)
  - [Examples](#examples)
- [Nested Tables](#nested-tables)
  - [Definition](#definition-1)
  - [Use Cases](#use-cases-1)
  - [Examples](#examples-1)
- [VARRAYs (Variable-Size Arrays)](#varrays-variable-size-arrays)
  - [Definition](#definition-2)
  - [Use Cases](#use-cases-2)
  - [Examples](#examples-2)
- [Comparison of Collection Types](#comparison-of-collection-types)
- [Best Practices](#best-practices)

## Overview of Collections

Collections in PL/SQL are a powerful feature that allow you to group related data together. They can be used for a variety of tasks, such as:

- Storing intermediate results of queries
- Manipulating sets of data
- Passing multiple values between procedures

## Associative Arrays

### Definition

Associative Arrays (formerly known as Index-By Tables) are key-value pairs where each key is an index and each value is an element associated with that index. They are useful for situations where you need to access elements by unique keys.

### Use Cases

- Lookup tables where the index is a meaningful identifier.
- Temporary storage of data that needs to be indexed.

### Examples

#### 1. Basic Usage

```plsql
DECLARE
    TYPE emp_table IS TABLE OF employees%ROWTYPE INDEX BY PLS_INTEGER;
    emp_data emp_table;
BEGIN
    emp_data(1).employee_id := 100;
    emp_data(1).first_name := 'Steven';
    emp_data(1).last_name := 'King';
    
    DBMS_OUTPUT.PUT_LINE('Employee ID: ' || emp_data(1).employee_id);
    DBMS_OUTPUT.PUT_LINE('First Name: ' || emp_data(1).first_name);
END;
```

#### 2. Using Strings as Keys

```plsql
DECLARE
    TYPE emp_names IS TABLE OF employees%ROWTYPE INDEX BY VARCHAR2(20);
    emp_data emp_names;
BEGIN
    emp_data('SKING').employee_id := 100;
    emp_data('SKING').first_name := 'Steven';
    
    DBMS_OUTPUT.PUT_LINE('Employee ID: ' || emp_data('SKING').employee_id);
    DBMS_OUTPUT.PUT_LINE('First Name: ' || emp_data('SKING').first_name);
END;
```

## Nested Tables

### Definition

Nested Tables are collections that can grow dynamically. Unlike arrays, nested tables can be stored in database columns and can contain an arbitrary number of elements.

### Use Cases

- Storing sets of data in a single row of a database table.
- Managing collections of objects where the number of elements is not known in advance.

### Examples

#### 1. Declaring and Using Nested Tables

```plsql
DECLARE
    TYPE number_table IS TABLE OF NUMBER;
    num_list number_table;
BEGIN
    num_list := number_table(1, 2, 3, 4, 5);
    
    FOR i IN 1 .. num_list.COUNT LOOP
        DBMS_OUTPUT.PUT_LINE('Number: ' || num_list(i));
    END LOOP;
END;
```

#### 2. Nested Table as a Column

```plsql
-- Create a type and table to hold nested tables
CREATE OR REPLACE TYPE num_table_type AS TABLE OF NUMBER;

CREATE TABLE numbers_table (
    id NUMBER,
    numbers num_table_type
) NESTED TABLE numbers STORE AS numbers_table_nested;

-- PL/SQL code to insert and query data
DECLARE
    l_numbers num_table_type := num_table_type(10, 20, 30);
BEGIN
    INSERT INTO numbers_table (id, numbers)
    VALUES (1, l_numbers);
    
    FOR rec IN (SELECT * FROM numbers_table) LOOP
        DBMS_OUTPUT.PUT_LINE('ID: ' || rec.id);
        FOR i IN 1 .. rec.numbers.COUNT LOOP
            DBMS_OUTPUT.PUT_LINE('Number: ' || rec.numbers(i));
        END LOOP;
    END LOOP;
END;
```

## VARRAYs (Variable-Size Arrays)

### Definition

VARRAYs (Variable-Size Arrays) are arrays with a fixed maximum size. They are useful when you need to store a fixed number of elements in a collection.

### Use Cases

- Storing a fixed-size set of values that do not need to grow beyond a specified limit.
- Efficient storage and retrieval of small sets of data.

### Examples

#### 1. Declaring and Using VARRAYs

```plsql
-- Create a VARRAY type
CREATE OR REPLACE TYPE varray_type AS VARRAY(5) OF NUMBER;

-- PL/SQL code to use VARRAY
DECLARE
    l_varray varray_type := varray_type(1, 2, 3);
BEGIN
    FOR i IN 1 .. l_varray.COUNT LOOP
        DBMS_OUTPUT.PUT_LINE('Number: ' || l_varray(i));
    END LOOP;
END;
```

#### 2. VARRAY as a Column

```plsql
-- Create a table with a VARRAY column
CREATE TABLE varray_table (
    id NUMBER,
    numbers varray_type
);

-- PL/SQL code to insert and query data
DECLARE
    l_varray varray_type := varray_type(10, 20, 30, 40);
BEGIN
    INSERT INTO varray_table (id, numbers)
    VALUES (1, l_varray);
    
    FOR rec IN (SELECT * FROM varray_table) LOOP
        DBMS_OUTPUT.PUT_LINE('ID: ' || rec.id);
        FOR i IN 1 .. rec.numbers.COUNT LOOP
            DBMS_OUTPUT.PUT_LINE('Number: ' || rec.numbers(i));
        END LOOP;
    END LOOP;
END;
```

## Comparison of Collection Types

| Feature                   | Associative Arrays      | Nested Tables            | VARRAYs                   |
|---------------------------|--------------------------|---------------------------|---------------------------|
| **Index Type**            | Integer or String        | Integer                    | Integer                   |
| **Dynamic Size**          | No                       | Yes                        | No                        |
| **Storage in DB**         | No                       | Yes                        | Yes                       |
| **Use Case**              | Lookup tables, indexing  | Complex data, variable-size | Fixed-size data, small sets |
| **Performance**           | Fast access by index     | Dynamic operations        | Fixed size, efficient     |

## Best Practices

- **Use Associative Arrays** when you need fast lookups with unique keys and you donâ€™t need to store the data in the database.
- **Use Nested Tables** when you need to store variable-sized collections in the database and require dynamic resizing.
- **Use VARRAYs** when you have a fixed number of elements and need to store them efficiently.

In summary, understanding and choosing the right type of collection for your needs can significantly impact the performance and maintainability of your PL/SQL applications.

