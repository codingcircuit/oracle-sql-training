# 6. Cursors

Cursors in PL/SQL are used to handle the result sets of SQL queries. They allow you to fetch and process multiple rows of data one at a time. This document covers the basics of cursors, including types, usage, and practical examples.

## 1. Introduction to Cursors

A cursor is a database object that allows you to retrieve rows from a result set and process them row by row. PL/SQL supports two types of cursors:

- **Implicit Cursors**: Automatically created by Oracle when a SQL query is executed.
- **Explicit Cursors**: Defined and controlled by the programmer to handle complex queries.

## 2. Implicit Cursors

Implicit cursors are automatically created by Oracle for single-row queries. They are used for simple `SELECT INTO` statements.

### Example

```sql
BEGIN
    DECLARE
        v_employee_name VARCHAR2(50);
    BEGIN
        -- Implicit cursor for single-row query
        SELECT first_name INTO v_employee_name
        FROM employees
        WHERE employee_id = 100;
        
        DBMS_OUTPUT.PUT_LINE('Employee Name: ' || v_employee_name);
    END;
END;
```

## 3. Explicit Cursors

Explicit cursors provide more control over the context area and are used for queries that return multiple rows. They need to be declared, opened, fetched from, and closed explicitly.

### 3.1 Declaring a Cursor

The cursor is declared in the declarative section of a PL/SQL block, procedure, or function.

```sql
DECLARE
    CURSOR emp_cursor IS
        SELECT first_name, last_name FROM employees;
BEGIN
    -- Cursor operations go here
END;
```

### 3.2 Opening a Cursor

Opening a cursor allocates memory and executes the query associated with the cursor.

```sql
OPEN emp_cursor;
```

### 3.3 Fetching Rows from a Cursor

Fetching retrieves the rows returned by the cursor one at a time.

```sql
FETCH emp_cursor INTO v_first_name, v_last_name;
```

### 3.4 Closing a Cursor

Closing a cursor releases the memory associated with it.

```sql
CLOSE emp_cursor;
```

### Complete Example

```sql
DECLARE
    CURSOR emp_cursor IS
        SELECT first_name, last_name FROM employees;
    
    v_first_name VARCHAR2(50);
    v_last_name VARCHAR2(50);
BEGIN
    OPEN emp_cursor;
    
    LOOP
        FETCH emp_cursor INTO v_first_name, v_last_name;
        EXIT WHEN emp_cursor%NOTFOUND;
        
        DBMS_OUTPUT.PUT_LINE('Employee: ' || v_first_name || ' ' || v_last_name);
    END LOOP;
    
    CLOSE emp_cursor;
END;
```

## 4. Cursor Attributes

Cursor attributes are used to get information about the cursor.

- `%FOUND`: Returns `TRUE` if the last fetch returned a row, `FALSE` otherwise.
- `%NOTFOUND`: Returns `TRUE` if the last fetch did not return a row, `FALSE` otherwise.
- `%ROWCOUNT`: Returns the number of rows fetched so far.

### Example

```sql
DECLARE
    CURSOR emp_cursor IS
        SELECT first_name FROM employees;
    
    v_first_name VARCHAR2(50);
BEGIN
    OPEN emp_cursor;
    
    FETCH emp_cursor INTO v_first_name;
    
    IF emp_cursor%FOUND THEN
        DBMS_OUTPUT.PUT_LINE('Fetched: ' || v_first_name);
    END IF;
    
    DBMS_OUTPUT.PUT_LINE('Rows fetched: ' || emp_cursor%ROWCOUNT);
    
    CLOSE emp_cursor;
END;
```

## 5. Ref Cursors

Ref cursors are pointers to query result sets. They are flexible and can be used to pass result sets between PL/SQL programs and procedures.

### Example

```sql
DECLARE
    TYPE ref_cursor_type IS REF CURSOR;
    v_cursor ref_cursor_type;
    v_first_name VARCHAR2(50);
    v_last_name VARCHAR2(50);
BEGIN
    OPEN v_cursor FOR
        SELECT first_name, last_name FROM employees;
    
    LOOP
        FETCH v_cursor INTO v_first_name, v_last_name;
        EXIT WHEN v_cursor%NOTFOUND;
        
        DBMS_OUTPUT.PUT_LINE('Employee: ' || v_first_name || ' ' || v_last_name);
    END LOOP;
    
    CLOSE v_cursor;
END;
```

## 6. Use Cases for Cursors

### 6.1 Processing Large Result Sets

Cursors are ideal for processing large result sets in manageable chunks, allowing efficient memory usage.

### Example

```sql
DECLARE
    CURSOR emp_cursor IS
        SELECT employee_id, first_name FROM employees;
    
    v_employee_id NUMBER;
    v_first_name VARCHAR2(50);
BEGIN
    OPEN emp_cursor;
    
    LOOP
        FETCH emp_cursor INTO v_employee_id, v_first_name;
        EXIT WHEN emp_cursor%NOTFOUND;
        
        -- Process each row
        DBMS_OUTPUT.PUT_LINE('Processing Employee ID: ' || v_employee_id || ', Name: ' || v_first_name);
    END LOOP;
    
    CLOSE emp_cursor;
END;
```

### 6.2 Cursor FOR LOOP

The `FOR` loop simplifies cursor handling by automatically opening, fetching, and closing the cursor.

### Example

```sql
BEGIN
    FOR emp_record IN (SELECT first_name, last_name FROM employees) LOOP
        DBMS_OUTPUT.PUT_LINE('Employee: ' || emp_record.first_name || ' ' || emp_record.last_name);
    END LOOP;
END;
```

### 6.3 Using Cursors in Procedures

Cursors can be passed as parameters to procedures for flexible querying.

### Example

```sql
CREATE OR REPLACE PROCEDURE process_employees(p_cursor IN SYS_REFCURSOR) IS
    v_first_name VARCHAR2(50);
    v_last_name VARCHAR2(50);
BEGIN
    LOOP
        FETCH p_cursor INTO v_first_name, v_last_name;
        EXIT WHEN p_cursor%NOTFOUND;
        
        DBMS_OUTPUT.PUT_LINE('Employee: ' || v_first_name || ' ' || v_last_name);
    END LOOP;
    
    CLOSE p_cursor;
END;
```
